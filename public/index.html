<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
	<script src="choropleth.js"></script>
	<style type="text/css">
		*{
			box-sizing: border-box;
		}
		html, body {
			margin: 0;
			padding: 0;
			font-family: helvetica, arial, sans-serif;
		}

		#map {
			background-color: #fff;
			border: 1px solid #ccc;
			position: relative;
		}
		.loader {
			background-color: #bae4b3;
			position: absolute;
		  top: 0;
		  left: 0;
		  height: 100%;
		  width: 100%;
		  opacity: .8;
		}
		.loader .loaderCenter {
			position: absolute;
		  top: 50%;
		  left: 50%;
		  transform: translate(-50%, -50%);
		  color: white;
		}
		#table {
			width: 100%;
		}
		#table .cell {
			display: inline-block;
			min-width: 100px;
			border: 1px solid lightgrey;
		}
		.background {
			fill: none;
			pointer-events: all;
		}
		#countries, #states {
			fill: #cde;
			stroke: #fff;
			stroke-linejoin: round;
			stroke-linecap: round;
		}
		.tooltip{ 
			background-color:whitesmoke;;
      margin: 10px;
      min-height: 50px;
      width: 180px;
      padding:5px;
      border: 2px solid lightgrey;
		}
		.country{
			fill: whitesmoke;
		}
		.country-border{
			fill: none;
			stroke: darkslategray;
		}
		.active-land {
			fill: #99CCCC;
			stroke: darkslategray;
		}
		.color-scale-0 {
			fill: #edf8e9;
		}
		.color-scale-1 {
			fill: #bae4b3;
		} 
		.color-scale-2 {
			fill: #74c476;
		}
		.color-scale-3 {
			fill: #31a354;
		}
		.color-scale-4 {
			fill: #006d2c;
		}
		.coolSpinner {
			/* from http://projects.lukehaas.me/css-loaders/ */
		  margin: 60px auto;
		  font-size: 10px;
		  position: relative;
		  text-indent: -9999em;
		  border-top: 1.1em solid rgba(255, 255, 255, 0.2);
		  border-right: 1.1em solid rgba(255, 255, 255, 0.2);
		  border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
		  border-left: 1.1em solid #ffffff;
		  -webkit-transform: translateZ(0);
		  -ms-transform: translateZ(0);
		  transform: translateZ(0);
		  -webkit-animation: load8 1.1s infinite linear;
		  animation: load8 1.1s infinite linear;
		}
		.coolSpinner,
		.coolSpinner:after {
		  border-radius: 50%;
		  width: 10em;
		  height: 10em;
		}
		@-webkit-keyframes load8 {
		  0% {
		    -webkit-transform: rotate(0deg);
		    transform: rotate(0deg);
		  }
		  100% {
		    -webkit-transform: rotate(360deg);
		    transform: rotate(360deg);
		  }
		}
		@keyframes load8 {
		  0% {
		    -webkit-transform: rotate(0deg);
		    transform: rotate(0deg);
		  }
		  100% {
		    -webkit-transform: rotate(360deg);
		    transform: rotate(360deg);
		  }
		}

	</style>
</head>
<body>
	<div id="map"></div>
	<div id="table"></div>
	<script type="text/javascript">
	  // some function to manipulate other elements 
		var updateTable = function(data){
			var $table = $('#table');
			$table.empty();
			$.each(data,function(key, value){
				// USA: {value: 1, children: {}}
				console.log(key, value)
				if(!value['value']){ return; }
				var domStr = '';
				domStr += "<div class='row'>"
				domStr += "<div class='cell key'>" + key + "</div>"
				domStr += "<div class='cell value'>" + value['value'] + "</div>"
				domStr += "</div>"
				$table.append(domStr);
			})
		};

		var dataObj = {};

		var choropleth = new Choropleth({
			mapSelector: '#map',
			dataStore: dataObj, 
			loadingText: '<div class="coolSpinner"></div>',
			onClick: function(selection){
				// {zoom: 'state', country: 'USA', state: 'CA'}
				var self = this;
				var info = self.get(selection);
				if(info){
					self.render(selection);
					updateTable(info);
				} else {
					$.ajax({
						url: "/geodata",
						data: selection,
						dataType: 'json',
						success: function(data){
							// data = {'San Francisco': 4, 'Los Angeles': 10, 'San Diego': 3}
							self.insert(data, selection);
							self.render(selection);
							updateTable(self.get(selection));
						}
					});
				};
			}
		})
	</script>
</body>
</html>